import "pe"

rule DetectUPXPacked {
    meta:
        description = "Detects files packed with UPX, a common packer used by malware."
        author = "YourName"
    strings:
        $upx = "UPX!" ascii wide nocase
    condition:
        $upx
}

rule SuspiciousImports {
    meta:
        description = "Detects suspicious API imports that are frequently leveraged by malware."
        author = "YourName"
    condition:
        pe.number_of_imported_functions > 20 and (
            "VirtualAlloc" in pe.imported_functions or
            "WriteProcessMemory" in pe.imported_functions or
            "CreateRemoteThread" in pe.imported_functions or
            "LoadLibraryA" in pe.imported_functions or
            "GetProcAddress" in pe.imported_functions
        )
}

rule SuspiciousExecutableSection {
    meta:
        description = "Detects executable sections in a PE file that are not the standard .text section."
        author = "YourName"
    condition:
        for any section in pe.sections : (
            (section.characteristics & 0x20000000) and // IMAGE_SCN_MEM_EXECUTE flag
            (section.name != ".text")
        )
}

rule DetectPackedExecutable {
    meta:
        description = "Detects files that appear to be packed using common packers like UPX, ASPack, or Themida."
        author = "YourName"
    strings:
        $upx     = "UPX!" ascii wide nocase,
        $aspack  = "ASPack" ascii wide nocase,
        $themida = "Themida" ascii wide nocase
    condition:
        any of ($upx, $aspack, $themida)
}

rule HighEntropySections {
    meta:
        description = "Detects high entropy sections in a PE file, which may indicate packing or encryption."
        author = "YourName"
    condition:
        for any section in pe.sections : (section.entropy > 7.5)
}
