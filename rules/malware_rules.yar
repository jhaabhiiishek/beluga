import "pe"

rule DetectUPXPacked {
    meta:
        description = "Detects files packed with UPX, a common packer used by malware."
        author = "AbhishekJha"
    strings:
        $upx = "UPX!" ascii wide nocase
    condition:
        pe.is_pe and $upx
}

rule SuspiciousImports {
    meta:
        description = "Detects suspicious API imports by scanning for key function names."
        author = "AbhishekJha"
    strings:
        $virtualalloc   = "VirtualAlloc" ascii wide nocase
        $writeprocess   = "WriteProcessMemory" ascii wide nocase
        $createremote   = "CreateRemoteThread" ascii wide nocase
        $loadlibrarya   = "LoadLibraryA" ascii wide nocase
        $getprocaddress = "GetProcAddress" ascii wide nocase
    condition:
        pe.is_pe and any of ($virtualalloc, $writeprocess, $createremote, $loadlibrarya, $getprocaddress)
}

rule SuspiciousExecutableSection {
    meta:
        description = "Detects executable sections in a PE file that are not the standard .text section."
        author = "AbhishekJha"
    condition:
        pe.is_pe and
        for any section in pe.sections : (
            (section.characteristics & 0x20000000) and
            (section.name != ".text")
        )
}

rule DetectPackedExecutable {
    meta:
        description = "Detects files that appear to be packed using common packers like UPX, ASPack, or Themida."
        author = "AbhishekJha"
    strings:
        $upx    = "UPX!" ascii wide nocase
        $aspack = "ASPack" ascii wide nocase
        $themida= "Themida" ascii wide nocase
    condition:
        pe.is_pe and any of ($upx, $aspack, $themida)
}

rule DetectSuspiciousPDF {
    meta:
        description = "Detects potentially malicious PDFs by looking for embedded JavaScript or suspicious actions."
        author = "AbhishekJha"
    strings:
        $pdfHeader = "%PDF-" ascii
        $js = "/JavaScript" ascii
        $openAction = "/OpenAction" ascii
    condition:
        $pdfHeader and ($js or $openAction)
}

rule DetectMacrosInDocx {
    meta:
        description = "Detects DOCX files that may contain macros (often found in DOCM files)."
        author = "AbhishekJha"
    strings:
        $vba = "VBAProject.bin" ascii
    condition:
        $vba
}
